function f(c){return String(c).split("").map(n=>n.charCodeAt(0))}function g(c){return new Uint8Array(f(c))}function h(c){const n=new ArrayBuffer(2*c.length),t=new Uint8Array(n);return new Uint16Array(n).set(f(c)),t}function u(c){return[c>>>24&255,c>>>16&255,c>>>8&255,c&255]}function m(c){return 11+c}function p(c,n,t,i){return 11+n+1+1+(i?2+2*(t+1):t+1)+c}function d(c){let n=0;return c.forEach(t=>{n+=2+2*t[0].length+2+2+2*t[1].length+2}),11+n}function T(c,n){const t=2*n;let i=0;return c.forEach(s=>{i+=2+2*s[0].length+2+4}),18+t+2+i}class y{_setIntegerFrame(n,t){const i=parseInt(t,10);this.frames.push({name:n,value:i,size:m(i.toString().length)})}_setStringFrame(n,t){const i=t.toString();let s=13+2*i.length;n==="TDAT"&&(s=m(i.length)),this.frames.push({name:n,value:i,size:s})}_setPictureFrame(n,t,i,s){const a=(function(r){if(!r||!r.length)return null;if(r[0]===255&&r[1]===216&&r[2]===255)return"image/jpeg";if(r[0]===137&&r[1]===80&&r[2]===78&&r[3]===71)return"image/png";if(r[0]===71&&r[1]===73&&r[2]===70)return"image/gif";if(r[8]===87&&r[9]===69&&r[10]===66&&r[11]===80)return"image/webp";const o=r[0]===73&&r[1]===73&&r[2]===42&&r[3]===0,l=r[0]===77&&r[1]===77&&r[2]===0&&r[3]===42;return o||l?"image/tiff":r[0]===66&&r[1]===77?"image/bmp":r[0]===0&&r[1]===0&&r[2]===1&&r[3]===0?"image/x-icon":null})(new Uint8Array(t)),e=i.toString();if(!a)throw new Error("Unknown picture MIME type");i||(s=!1),this.frames.push({name:"APIC",value:t,pictureType:n,mimeType:a,useUnicodeEncoding:s,description:e,size:p(t.byteLength,a.length,e.length,s)})}_setLyricsFrame(n,t,i){const s=n.split("").map(l=>l.charCodeAt(0)),a=t.toString(),e=i.toString();var r,o;this.frames.push({name:"USLT",value:e,language:s,description:a,size:(r=a.length,o=e.length,16+2*r+2+2+2*o)})}_setCommentFrame(n,t,i){const s=n.split("").map(l=>l.charCodeAt(0)),a=t.toString(),e=i.toString();var r,o;this.frames.push({name:"COMM",value:e,language:s,description:a,size:(r=a.length,o=e.length,16+2*r+2+2+2*o)})}_setPrivateFrame(n,t){const i=n.toString();var s,a;this.frames.push({name:"PRIV",value:t,id:i,size:(s=i.length,a=t.byteLength,10+s+1+a)})}_setUserStringFrame(n,t){const i=n.toString(),s=t.toString();var a,e;this.frames.push({name:"TXXX",description:i,value:s,size:(a=i.length,e=s.length,13+2*a+2+2+2*e)})}_setUrlLinkFrame(n,t){const i=t.toString();var s;this.frames.push({name:n,value:i,size:(s=i.length,10+s)})}_setPairedTextFrame(n,t){this.frames.push({name:n,value:t,size:d(t)})}_setSynchronisedLyricsFrame(n,t,i,s,a){const e=a.toString(),r=s.split("").map(o=>o.charCodeAt(0));this.frames.push({name:"SYLT",value:t,language:r,description:e,type:n,timestampFormat:i,size:T(t,e.length)})}constructor(n){if(!n||typeof n!="object"||!("byteLength"in n))throw new Error("First argument should be an instance of ArrayBuffer or Buffer");this.arrayBuffer=n,this.padding=4096,this.frames=[],this.url=""}setFrame(n,t){switch(n){case"TPE1":case"TCOM":case"TCON":{if(!Array.isArray(t))throw new Error(`${n} frame value should be an array of strings`);const i=n==="TCON"?";":"/",s=t.join(i);this._setStringFrame(n,s);break}case"TLAN":case"TIT1":case"TIT2":case"TIT3":case"TALB":case"TPE2":case"TPE3":case"TPE4":case"TRCK":case"TPOS":case"TMED":case"TPUB":case"TCOP":case"TKEY":case"TEXT":case"TDAT":case"TCMP":case"TSSE":case"TSRC":this._setStringFrame(n,t);break;case"TBPM":case"TLEN":case"TYER":this._setIntegerFrame(n,t);break;case"USLT":if(t.language=t.language||"eng",typeof t!="object"||!("description"in t)||!("lyrics"in t))throw new Error("USLT frame value should be an object with keys description and lyrics");if(t.language&&!t.language.match(/[a-z]{3}/i))throw new Error("Language must be coded following the ISO 639-2 standards");this._setLyricsFrame(t.language,t.description,t.lyrics);break;case"APIC":if(typeof t!="object"||!("type"in t)||!("data"in t)||!("description"in t))throw new Error("APIC frame value should be an object with keys type, data and description");if(t.type<0||t.type>20)throw new Error("Incorrect APIC frame picture type");this._setPictureFrame(t.type,t.data,t.description,!!t.useUnicodeEncoding);break;case"TXXX":if(typeof t!="object"||!("description"in t)||!("value"in t))throw new Error("TXXX frame value should be an object with keys description and value");this._setUserStringFrame(t.description,t.value);break;case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":this._setUrlLinkFrame(n,t);break;case"COMM":if(t.language=t.language||"eng",typeof t!="object"||!("description"in t)||!("text"in t))throw new Error("COMM frame value should be an object with keys description and text");if(t.language&&!t.language.match(/[a-z]{3}/i))throw new Error("Language must be coded following the ISO 639-2 standards");this._setCommentFrame(t.language,t.description,t.text);break;case"PRIV":if(typeof t!="object"||!("id"in t)||!("data"in t))throw new Error("PRIV frame value should be an object with keys id and data");this._setPrivateFrame(t.id,t.data);break;case"IPLS":if(!Array.isArray(t)||!Array.isArray(t[0]))throw new Error("IPLS frame value should be an array of pairs");this._setPairedTextFrame(n,t);break;case"SYLT":if(typeof t!="object"||!("type"in t)||!("text"in t)||!("timestampFormat"in t))throw new Error("SYLT frame value should be an object with keys type, text and timestampFormat");if(!Array.isArray(t.text)||!Array.isArray(t.text[0]))throw new Error("SYLT frame text value should be an array of pairs");if(t.type<0||t.type>6)throw new Error("Incorrect SYLT frame content type");if(t.timestampFormat<1||t.timestampFormat>2)throw new Error("Incorrect SYLT frame time stamp format");t.language=t.language||"eng",t.description=t.description||"",this._setSynchronisedLyricsFrame(t.type,t.text,t.timestampFormat,t.language,t.description);break;default:throw new Error(`Unsupported frame ${n}`)}return this}removeTag(){if(this.arrayBuffer.byteLength<10)return;const n=new Uint8Array(this.arrayBuffer),t=n[3],i=((s=[n[6],n[7],n[8],n[9]])[0]<<21)+(s[1]<<14)+(s[2]<<7)+s[3]+10;var s,a;(a=n)[0]!==73||a[1]!==68||a[2]!==51||t<2||t>4||(this.arrayBuffer=new Uint8Array(n.subarray(i)).buffer)}addTag(){this.removeTag();const n=[255,254],t=10+this.frames.reduce((r,o)=>r+o.size,0)+this.padding,i=new ArrayBuffer(this.arrayBuffer.byteLength+t),s=new Uint8Array(i);let a=0,e=[];return e=[73,68,51,3],s.set(e,a),a+=e.length,a++,a++,e=(function(r){return[r>>>21&127,r>>>14&127,r>>>7&127,r&127]})(t-10),s.set(e,a),a+=e.length,this.frames.forEach(r=>{switch(e=g(r.name),s.set(e,a),a+=e.length,e=u(r.size-10),s.set(e,a),a+=e.length,a+=2,r.name){case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":e=g(r.value),s.set(e,a),a+=e.length;break;case"TPE1":case"TCOM":case"TCON":case"TLAN":case"TIT1":case"TIT2":case"TIT3":case"TALB":case"TPE2":case"TPE3":case"TPE4":case"TRCK":case"TPOS":case"TKEY":case"TMED":case"TPUB":case"TCOP":case"TEXT":case"TSSE":case"TSRC":e=[1].concat(n),s.set(e,a),a+=e.length,e=h(r.value),s.set(e,a),a+=e.length;break;case"TXXX":case"USLT":case"COMM":e=[1],r.name!=="USLT"&&r.name!=="COMM"||(e=e.concat(r.language)),e=e.concat(n),s.set(e,a),a+=e.length,e=h(r.description),s.set(e,a),a+=e.length,e=[0,0].concat(n),s.set(e,a),a+=e.length,e=h(r.value),s.set(e,a),a+=e.length;break;case"TBPM":case"TLEN":case"TDAT":case"TYER":a++,e=g(r.value),s.set(e,a),a+=e.length;break;case"PRIV":e=g(r.id),s.set(e,a),a+=e.length,a++,s.set(new Uint8Array(r.value),a),a+=r.value.byteLength;break;case"APIC":e=[r.useUnicodeEncoding?1:0],s.set(e,a),a+=e.length,e=g(r.mimeType),s.set(e,a),a+=e.length,e=[0,r.pictureType],s.set(e,a),a+=e.length,r.useUnicodeEncoding?(e=[].concat(n),s.set(e,a),a+=e.length,e=h(r.description),s.set(e,a),a+=e.length,a+=2):(e=g(r.description),s.set(e,a),a+=e.length,a++),s.set(new Uint8Array(r.value),a),a+=r.value.byteLength;break;case"IPLS":e=[1],s.set(e,a),a+=e.length,r.value.forEach(o=>{e=[].concat(n),s.set(e,a),a+=e.length,e=h(o[0].toString()),s.set(e,a),a+=e.length,e=[0,0].concat(n),s.set(e,a),a+=e.length,e=h(o[1].toString()),s.set(e,a),a+=e.length,e=[0,0],s.set(e,a),a+=e.length});break;case"SYLT":e=[1].concat(r.language).concat(r.timestampFormat).concat(r.type),s.set(e,a),a+=e.length,e=[].concat(n),s.set(e,a),a+=e.length,e=h(r.description),s.set(e,a),a+=e.length,a+=2,r.value.forEach(o=>{e=[].concat(n),s.set(e,a),a+=e.length,e=h(o[0].toString()),s.set(e,a),a+=e.length,e=[0,0],s.set(e,a),a+=e.length,e=u(o[1]),s.set(e,a),a+=e.length})}}),a+=this.padding,s.set(new Uint8Array(this.arrayBuffer),a),this.arrayBuffer=i,i}getBlob(){return new Blob([this.arrayBuffer],{type:"audio/mpeg"})}getURL(){return this.url||(this.url=URL.createObjectURL(this.getBlob())),this.url}revokeURL(){URL.revokeObjectURL(this.url)}}export{y as ID3Writer};
